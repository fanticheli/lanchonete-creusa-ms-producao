name: SONAR
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  
  wait-sonarcloud:
    needs: sonarcloud
    runs-on: ubuntu-latest

    steps:
      - name: Wait for SonarCloud status
        run: |
          while [[ "$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.antiope-preview+json" https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PULL_REQUEST_ID/checks | jq -r ".check_runs[] | select(.app.slug == \"sonarcloud\") | .conclusion")" == "null" ]]; do
            echo "Waiting for SonarCloud analysis to complete..."
            sleep 10
          done

          status=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.antiope-preview+json" https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PULL_REQUEST_ID/checks | jq -r ".check_runs[] | select(.app.slug == \"sonarcloud\") | .conclusion")

          if [ "$status" != "success" ]; then
            echo "SonarCloud analysis failed. Exiting..."
            exit 1
          else
            echo "SonarCloud analysis successful. Continuing..."
          fi
